---
title: etcd/raft库的使用
date: 2024-08-03 17:00:00 +0800
categories: [etcd/raft笔记]
tags: [etcd,raft]
---
## 1. 前言

raft是一个共识算法，所谓共识就是：即使在部分节点发生故障、网络延时、网络分区的情况下，多个节点还能对某个事情达成一致性的看法。在etcd中使用的共识算法就是raft，其实现的raft库实现非常精妙，屏蔽了网络、存储等模块，提供了接口由上层应用者实现。而在深入理解etcd中raft的原理之前，首先要学会怎么使用etcd中的raft库。恰好etcd中提供了使用raft库的简单用例--raftexample，我们以raftexample为切入点，进一步学习如何使用etcd中的raft库。

## 2. etcd-raft模块使用介绍

etcd-raft模块是etcd中解决分布式一致性模块，作为一致性算法库，etcd-raft模块使用的场景一般如下：

1. 应用层接受到新的数据写入，向该算法库写入一个数据。
2. 算法库返回是否写入成功。
3. 应用层根据写入结果进行下一步操作。

相对而言raft库更复杂一些，因为有以下问题存在：

1. 写入的数据可能是集群状态变更的数据，raft库在执行写入这类数据后，需要返回新的状态给应用层。
2. raft库中的数据不可能一直以日志的形式存在，这样会导致数据越来越大，所以有可能被压缩成快照，这种情况下也需要返回生成的快照数据。
3. 由于etcd的raft库不包括持久化数据存储相关的模块，需要由应用层自己实现，所以也需要返回在某次写入成功后，哪些数据可以进行持久化保存。
4. etcd的raft库本身并未实现网络传输，因此同样需要返回哪些数据需要进行网络传输给集群中的其他节点。

这些问题具体是如何解决呢？首先了解在etcd项目中如何使用etcd-raft模块。etcd项目中包含raft库使用的示例，位于contrib/raftexample目录。raftexample基于etcd-raft库实现了一个简单的键值对存储服务器。

### 2.1 raftexample运行

可以执行以下命令运行raftexample

1. 更新依赖，在终端切换到contrib/raftexample目录中， 执行 go mod tidy 命令。  
2. 编译，执行go build命令。  
3. 启动服务进程，执行 goreman start命令。  

然后观察终端信息，可以很清楚看到raft在启动过程中的选举过程  
![raftexample节点选举过程](/assets/image/bdf69521d72d91313b778f222515c91c644732a7863dca870705c99436843e3e.png)  

### 2.2 raftexample应用架构

![raftexample应用架构](/assets/image/5e38b36d8a0992a28c55f510102d50591bef020d699c8b4dc6d15ea3093c8566.png)  

raft应用集群由多个节点组成，集群中的每个节点从架构都可以分为两层：

- 应用层：负责处理用户请求，数据存储以及集群节点间的网络通信
- 共识层：负责管理来自应用层请求的日志副本，以完全相同的顺序执行日志中的命令，并产生完全相同的输出

共识层由etcd-raft模块负责，应用层要负责业务逻辑、数据存储、各节点之间的网络通信